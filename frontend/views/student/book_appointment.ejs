<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Appointment | Campus Wellness</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
    }

    .page-title {
      text-align: center;
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 30px;
      color: #333;
    }

    .filters-section {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
    }

    .filters-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 15px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-group label {
      font-weight: 500;
      color: #555;
      font-size: 0.95rem;
    }

    .filter-group select,
    .filter-group input {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      background: #f9f9f9;
    }

    .filter-group select:focus,
    .filter-group input:focus {
      outline: none;
      border-color: #0d6efd;
      background: #fff;
    }

    .filter-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-filter {
      padding: 10px 24px;
      background: #0d6efd;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-filter:hover {
      background: #0b5ed7;
    }

    .btn-reset {
      padding: 10px 24px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-reset:hover {
      background: #5a6268;
    }

    .appointments-section {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #333;
    }

    .results-count {
      color: #666;
      font-size: 0.95rem;
    }

    .appointments-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .appointments-table thead {
      background: #f8f9fa;
    }

    .appointments-table th {
      padding: 14px 12px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #dee2e6;
    }

    .appointments-table td {
      padding: 14px 12px;
      border-bottom: 1px solid #e9ecef;
      color: #495057;
    }

    .appointments-table tbody tr {
      transition: background-color 0.2s;
    }

    .appointments-table tbody tr:hover {
      background-color: #f8f9fa;
    }

    .doctor-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .doctor-name {
      font-weight: 600;
      color: #333;
    }

    .doctor-specialization {
      font-size: 0.9rem;
      color: #6c757d;
    }

    .time-slot {
      font-weight: 500;
      color: #0d6efd;
    }

    .availability-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .badge-available {
      background: #d1e7dd;
      color: #0f5132;
    }

    .badge-limited {
      background: #fff3cd;
      color: #856404;
    }

    .badge-full {
      background: #f8d7da;
      color: #842029;
    }

    .btn-book {
      padding: 8px 20px;
      background: #198754;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .btn-book:hover {
      background: #157347;
    }

    .btn-book:disabled {
      background: #adb5bd;
      cursor: not-allowed;
    }

    .no-results {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }

    .no-results-icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }

    .no-results-text {
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .back-link {
      display: inline-block;
      margin-top: 20px;
      color: #0d6efd;
      text-decoration: none;
      font-weight: 500;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
  </style>
</head>

<body>
  <%- include('../partials/header') %>

  <% if (typeof success !== 'undefined' && success) { %>
    <script>
      // Friendly confirmation alert after successful booking
      alert('‚úÖ Appointment booked successfully!');
    </script>
  <% } %>

  <main class="main-content">
    <div class="container">
      <h1 class="page-title">Book Appointment</h1>

      <!-- Filters Section -->
      <div class="filters-section">
        <h2 class="filters-title">üîç Filter Available Appointments</h2>
        <div class="filters-grid">
          <div class="filter-group">
            <label for="filterDoctor">Doctor</label>
            <select id="filterDoctor" onchange="applyFilters()">
              <option value="">All Doctors</option>
              <% doctors.forEach(doctor => { %>
                <option value="<%= doctor.id %>"><%= doctor.name %></option>
              <% }); %>
            </select>
          </div>

          <div class="filter-group">
            <label for="filterSpecialization">Specialization</label>
            <select id="filterSpecialization" onchange="applyFilters()">
              <% if (specializations && specializations.length > 0) { %>
                <% specializations.forEach(function(spec) { %>
                  <option value="<%= spec === 'All Specializations' ? '' : spec %>"><%= spec %></option>
                <% }); %>
              <% } else { %>
                <option value="">All Specializations</option>
              <% } %>
            </select>
          </div>

          <div class="filter-group">
            <label for="filterDate">Date</label>
            <input type="date" id="filterDate" min="<%= new Date().toISOString().split('T')[0] %>" onchange="applyFilters()">
          </div>
        </div>

        <div class="filter-actions">
          <button class="btn-reset" onclick="resetFilters()">Reset Filters</button>
        </div>
      </div>

      <!-- Available Appointments Table -->
      <div class="appointments-section">
        <div class="section-header">
          <h2 class="section-title">üìÖ Available Appointments</h2>
          <span class="results-count" id="resultsCount">Showing all appointments</span>
        </div>

        <div id="tableContainer">
          <% if (availableSlots && availableSlots.length > 0) { %>
            <table class="appointments-table" id="appointmentsTable">
              <thead>
                <tr>
                  <th>Doctor</th>
                  <th>Date</th>
                  <th>Time Slot</th>
                  <th>Duration</th>
                  <th>Availability</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <% availableSlots.forEach(slot => { %>
                  <% const __d = new Date(slot.date); const __ds = __d.getFullYear() + '-' + String(__d.getMonth()+1).padStart(2,'0') + '-' + String(__d.getDate()).padStart(2,'0'); %>
                  <tr 
                    data-doctor-id="<%= slot.doctor_id %>"
                    data-specialization="<%= slot.specialization || '' %>"
                    data-date="<%= __ds %>"
                    data-time="<%= slot.start_time %>"
                    data-available="<%= slot.available_slots %>"
                  >
                    <td>
                      <div class="doctor-info">
                        <span class="doctor-name"><%= slot.doctor_name %></span>
                        <span class="doctor-specialization"><%= slot.specialization || 'General' %></span>
                      </div>
                    </td>
                    <td><%= new Date(slot.date).toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' }) %></td>
                    <td class="time-slot"><%= slot.start_time %> - <%= slot.end_time %></td>
                    <td><%= slot.time_per_patient %> min</td>
                    <td>
                      <% if (slot.available_slots > 5) { %>
                        <span class="availability-badge badge-available">
                          <%= slot.available_slots %> slots available
                        </span>
                      <% } else if (slot.available_slots > 0) { %>
                        <span class="availability-badge badge-limited">
                          <%= slot.available_slots %> slots left
                        </span>
                      <% } else { %>
                        <span class="availability-badge badge-full">
                          Fully Booked
                        </span>
                      <% } %>
                    </td>
                    <td>
                      <% const slotDate = new Date(slot.date); const slotDateStr = slotDate.getFullYear() + '-' + String(slotDate.getMonth()+1).padStart(2,'0') + '-' + String(slotDate.getDate()).padStart(2,'0'); %>
                      <form action="/book-appointment" method="POST" style="display: inline;">
                        <input type="hidden" name="doctor" value="<%= slot.doctor_id %>,<%= slot.doctor_name %>">
                        <input type="hidden" name="date" value="<%= slotDateStr %>">
                        <input type="hidden" name="time" value="<%= slot.start_time %>">
                        <button 
                          type="submit" 
                          class="btn-book"
                          <%= slot.available_slots <= 0 ? 'disabled' : '' %>
                        >
                          <%= slot.available_slots > 0 ? 'Book Now' : 'Full' %>
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          <% } else { %>
            <div class="no-results">
              <div class="no-results-icon">üì≠</div>
              <div class="no-results-text">No available appointments found</div>
              <p>Please check back later or try different filters.</p>
            </div>
          <% } %>
        </div>
      </div>

      
    </div>
  </main>

  <script>
    function applyFilters() {
      const doctorFilter = document.getElementById('filterDoctor').value;
      const specializationFilter = document.getElementById('filterSpecialization').value.toLowerCase();
      const dateFilter = document.getElementById('filterDate').value;

      const table = document.getElementById('appointmentsTable');
      if (!table) return;

      const rows = table.querySelectorAll('tbody tr');
      let visibleCount = 0;

      rows.forEach(row => {
        const doctorId = row.dataset.doctorId;
        const specialization = row.dataset.specialization.toLowerCase();
        const date = row.dataset.date;

        let show = true;

        // Filter by doctor
        if (doctorFilter && doctorId !== doctorFilter) {
          show = false;
        }

        // Filter by specialization
        if (specializationFilter && !specialization.includes(specializationFilter.toLowerCase())) {
          show = false;
        }

        // Filter by date
        if (dateFilter && date !== dateFilter) {
          show = false;
        }

        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
      });

      // Update results count
      document.getElementById('resultsCount').textContent = 
        `Showing ${visibleCount} of ${rows.length} appointments`;
    }

    function resetFilters() {
      document.getElementById('filterDoctor').value = '';
      document.getElementById('filterSpecialization').value = '';
      document.getElementById('filterDate').value = '';
      
      const table = document.getElementById('appointmentsTable');
      if (table) {
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => row.style.display = '');
        document.getElementById('resultsCount').textContent = 
          `Showing all ${rows.length} appointments`;
      }
    }
  </script>

  <%- include('../partials/footer') %>
</body>

</html>